#!/usr/bin/make -f

psource:=rtsp-conntrack-source
sname:=rtsp-conntrack
PACKAGE=rtsp-conntrack-modules
MA_DIR ?= /usr/share/modass
-include $(MA_DIR)/include/generic.make
-include $(MA_DIR)/include/common-rules.make

kdist_config: prep-deb-files

kdist_clean:
	$(MAKE) clean

build:

install: DH_OPTIONS=
install: build
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs
	dh_installdirs -p$(psource)  usr/src/modules/$(sname)/debian
	cp -a README.rst *.h nf_conntrack_rtsp.c nf_nat_rtsp.c Makefile \
	        debian/$(psource)/usr/src/modules/$(sname)
	cp debian/*modules.in* \
		debian/$(psource)/usr/src/modules/$(sname)/debian
	cp debian/control debian/rules debian/changelog debian/copyright \
		debian/compat debian/$(psource)/usr/src/modules/$(sname)/debian/
	sed -i 's!^\(include /usr/share/quilt/quilt.make\)$$!#\1!' debian/$(psource)/usr/src/modules/$(sname)/debian/rules
	cd debian/$(psource)/usr/src && tar c modules | bzip2 -9 > $(sname).tar.bz2 && rm -rf modules
	dh_install

clean:
	dh_testdir
	export KERNELSRC=$(KSRC)
	$(MAKE) clean
	dh_clean

binary-modules:
	dh_testroot
	dh_prep
	dh_installdirs \
		lib/modules/$(KVERS)/kernel/net/netfilter \
		lib/modules/$(KVERS)/kernel/net/ipv4/netfilter
	export KERNELSRC=$(KSRC)
	$(MAKE) KERNELSRC=$(KSRC) KERNELVERSION=$(KVERS)
	cp nf_conntrack_rtsp.ko debian/$(PKGNAME)/lib/modules/$(KVERS)/kernel/net/netfilter
	cp nf_nat_rtsp.ko debian/$(PKGNAME)/lib/modules/$(KVERS)/kernel/net/ipv4/netfilter
	dh_installmodules
	dh_installdocs
	dh_installchangelogs
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_gencontrol -- -v$(VERSION)
	dh_md5sums
	dh_builddeb --destdir=$(DEB_DESTDIR)
	dh_prep


binary: build install
	dh_testdir
	dh_testroot
	dh_installchangelogs
	dh_installdocs
	dh_installexamples
	dh_link
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

.PHONY: build clean binary install binary-modules kdist kdist_configure kdist_image kdist_clean
